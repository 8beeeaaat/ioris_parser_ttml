/**
 * @vitest-environment jsdom
 */

import { LineArgsTokenizer } from '@ioris/tokenizer-kuromoji';
import { IpadicFeatures, Tokenizer, builder } from 'kuromoji';
import path from 'path';
import { beforeEach, describe, expect, it } from 'vitest';
import TTMLParser from './Parser.TTMLParser';

const kuromojiBuilder = builder({
  dicPath: path.resolve(__dirname, '../node_modules/kuromoji/dict'),
});

const getTokenizer = (): Promise<Tokenizer<IpadicFeatures>> =>
  new Promise((resolve, reject) => {
    kuromojiBuilder.build((err, tokenizer) => {
      if (err) {
        reject(err);
      }
      resolve(tokenizer);
    });
  });

describe('TTMLParser', () => {
  let parser: TTMLParser;

  beforeEach(async () => {
    const tokenizer = await getTokenizer();
    parser = new TTMLParser({
      tokenizer: (lineArgs) =>
        LineArgsTokenizer({
          tokenizer,
          lineArgs,
        }),
    });
  });

  it('should parse syllable TTML document', () => {
    const xml = new DOMParser().parseFromString(
      `<tt xmlns="http://www.w3.org/ns/ttml" xmlns:itunes="http://music.apple.com/lyric-ttml-internal" xmlns:ttm="http://www.w3.org/ns/ttml#metadata" itunes:timing="Word" xml:lang="ja"><head><metadata><ttm:agent type="person" xml:id="v1"/><iTunesMetadata xmlns="http://music.apple.com/lyric-ttml-internal" leadingSilence="0.320"><songwriters><songwriter>Maguro Taniguchi</songwriter></songwriters></iTunesMetadata></metadata></head><body dur="3:22.827"><div begin="9.883" end="1:48.678"><p begin="9.883" end="15.323" itunes:key="L1" ttm:agent="v1"><span begin="9.883" end="11.241">踏みつけ</span><span begin="11.241" end="11.616">ら</span><span begin="11.616" end="11.946">れ</span><span begin="11.946" end="12.229">た</span><span begin="12.229" end="13.641">孤独と</span><span begin="13.641" end="14.683">ペダル</span><span begin="14.683" end="15.323">から</span></p><p begin="15.333" end="20.778" itunes:key="L2" ttm:agent="v1"><span begin="15.333" end="15.938">何</span><span begin="15.938" end="16.543">度も</span><span begin="16.543" end="17.094">鳴り</span><span begin="17.094" end="18.078">響く</span><span begin="18.078" end="18.582">音</span><span begin="18.582" end="18.804">色</span><span begin="18.804" end="19.218">が</span><span begin="19.218" end="19.831">頬</span><span begin="19.831" end="20.057">に</span><span begin="20.057" end="20.778">伝う</span></p><p begin="20.788" end="24.528" itunes:key="L3" ttm:agent="v1"><span begin="20.788" end="22.194">打ちつけ</span><span begin="22.194" end="23.223">られた</span><span begin="23.223" end="24.528">孤独に</span></p><p begin="24.538" end="28.621" itunes:key="L4" ttm:agent="v1"><span begin="24.538" end="25.910">スネアの</span><span begin="25.910" end="26.265">リ</span><span begin="26.265" end="26.777">ズ</span><span begin="26.777" end="26.943">ム</span><span begin="26.943" end="27.375">が</span><span begin="27.387" end="27.922">重</span><span begin="27.922" end="28.241">なっ</span><span begin="28.241" end="28.621">て</span></p><p begin="28.631" end="31.675" itunes:key="L5" ttm:agent="v1"><span begin="28.631" end="29.522">確</span><span begin="29.522" end="30.023">かな</span><span begin="30.023" end="31.018">鼓動に</span><span begin="31.018" end="31.675">なる</span></p><p begin="31.685" end="34.221" itunes:key="L6" ttm:agent="v1"><span begin="31.685" end="32.959">誰か心の</span><span begin="32.959" end="33.927">ノイズをとっ</span><span begin="33.927" end="34.221">て</span></p><p begin="34.231" end="37.060" itunes:key="L7" ttm:agent="v1"><span begin="34.231" end="34.500">わ</span><span begin="34.500" end="34.889">た</span><span begin="34.889" end="35.597">しを</span><span begin="35.598" end="36.281">覗</span><span begin="36.281" end="36.514">いて</span><span begin="36.514" end="37.060">よ</span></p><p begin="37.070" end="41.151" itunes:key="L8" ttm:agent="v1"><span begin="37.070" end="38.321">誰も心の</span><span begin="38.321" end="39.131">奥には</span><span begin="39.131" end="39.873">入れない</span><span begin="39.873" end="40.455">け</span><span begin="40.455" end="40.555">れ</span><span begin="40.555" end="41.151">ど</span></p><p begin="41.161" end="44.703" itunes:key="L9" ttm:agent="v1"><span begin="41.161" end="41.795">期待</span><span begin="41.795" end="42.630">してしまう</span> <span begin="42.630" end="43.285">そんな</span><span begin="43.285" end="44.703">夜</span></p><p begin="45.246" end="47.421" itunes:key="L10" ttm:agent="v1"><span begin="45.246" end="46.334">Distortion,</span> <span begin="46.334" end="46.878">it's</span> <span begin="46.878" end="47.421">Motion</span></p><p begin="47.431" end="50.792" itunes:key="L11" ttm:agent="v1"><span begin="47.431" end="47.912">始</span><span begin="47.912" end="48.512">まっ</span><span begin="48.512" end="48.994">たら</span><span begin="48.994" end="49.337">もう</span><span begin="49.337" end="49.755">止ま</span><span begin="49.755" end="50.792">らない</span></p><p begin="50.802" end="54.890" itunes:key="L12" ttm:agent="v1"><span begin="50.802" end="51.795">命題も</span><span begin="51.795" end="52.881">声帯で</span><span begin="52.881" end="53.560">震わせ</span><span begin="53.560" end="54.890">られるさ</span></p><p begin="54.905" end="56.169" itunes:key="L13" ttm:agent="v1"><span begin="54.905" end="56.169">そうだろう</span></p><p begin="56.184" end="58.291" itunes:key="L14" ttm:agent="v1"><span begin="56.184" end="57.310">ディスコード</span> <span begin="57.310" end="58.291">いつもそう</span></p><p begin="58.301" end="1:02.917" itunes:key="L15" ttm:agent="v1"><span begin="58.301" end="58.796">交</span><span begin="58.796" end="59.364">わ</span><span begin="59.364" end="59.833">らない</span><span begin="59.833" end="1:00.237">その</span><span begin="1:00.237" end="1:01.395">心を</span><span begin="1:01.395" end="1:02.225">繋</span><span begin="1:02.225" end="1:02.917">ぎたい</span></p><p begin="1:02.927" end="1:05.092" itunes:key="L16" ttm:agent="v1"><span begin="1:02.927" end="1:03.687">端っ</span><span begin="1:03.687" end="1:04.152">こ</span><span begin="1:04.152" end="1:05.092">でも</span></p><p begin="1:07.114" end="1:10.968" itunes:key="L17" ttm:agent="v1"><span begin="1:07.114" end="1:08.536">投げつけ</span><span begin="1:08.536" end="1:09.574">られた</span><span begin="1:09.574" end="1:10.968">言葉が</span></p><p begin="1:10.978" end="1:15.296" itunes:key="L18" ttm:agent="v1"><span begin="1:10.978" end="1:11.643">いつ</span><span begin="1:11.643" end="1:12.632">までも</span><span begin="1:12.632" end="1:13.082">な</span><span begin="1:13.082" end="1:13.323">んだ</span><span begin="1:13.323" end="1:13.771">か</span><span begin="1:13.771" end="1:14.650">消えない</span><span begin="1:14.650" end="1:15.296">まま</span></p><p begin="1:15.306" end="1:18.069" itunes:key="L19" ttm:agent="v1"><span begin="1:15.306" end="1:15.912">夕</span><span begin="1:15.912" end="1:16.082">暮</span><span begin="1:16.082" end="1:16.456">れ</span><span begin="1:16.456" end="1:16.626">の</span><span begin="1:16.626" end="1:17.095">影</span><span begin="1:17.095" end="1:18.069">みたいに</span></p><p begin="1:18.079" end="1:24.766" itunes:key="L20" ttm:agent="v1"><span begin="1:18.079" end="1:19.409">追いかけ</span><span begin="1:19.409" end="1:20.530">られて</span> <span begin="1:20.530" end="1:21.819">止まれば</span><span begin="1:21.819" end="1:23.525">飲み込まれ</span><span begin="1:23.525" end="1:24.082">そ</span><span begin="1:24.082" end="1:24.241">う</span><span begin="1:24.241" end="1:24.766">で</span></p><p begin="1:24.776" end="1:28.919" itunes:key="L21" ttm:agent="v1"><span begin="1:24.776" end="1:25.368">必死で</span><span begin="1:25.368" end="1:25.889">走っ</span><span begin="1:25.889" end="1:26.271">て</span> <span begin="1:26.271" end="1:26.962">また</span><span begin="1:26.962" end="1:27.907">夜を</span><span begin="1:27.907" end="1:28.457">待つん</span><span begin="1:28.457" end="1:28.919">だ</span></p><p begin="1:28.934" end="1:31.109" itunes:key="L22" ttm:agent="v1"><span begin="1:28.934" end="1:30.022">Distortion,</span> <span begin="1:30.022" end="1:30.566">it's</span> <span begin="1:30.566" end="1:31.109">Motion</span></p><p begin="1:31.025" end="1:34.420" itunes:key="L23" ttm:agent="v1"><span begin="1:31.025" end="1:31.540">始</span><span begin="1:31.540" end="1:32.098">まっ</span><span begin="1:32.098" end="1:32.231">た</span><span begin="1:32.231" end="1:32.556">ら</span><span begin="1:32.556" end="1:32.969">もう</span><span begin="1:32.969" end="1:34.420">怖くない</span></p><p begin="1:34.430" end="1:38.550" itunes:key="L24" ttm:agent="v1"><span begin="1:34.430" end="1:35.441">騒音と</span><span begin="1:35.441" end="1:36.464">轟音で</span><span begin="1:36.464" end="1:37.218">忘れら</span><span begin="1:37.218" end="1:37.586">れ</span><span begin="1:37.586" end="1:38.550">るから</span></p><p begin="1:38.565" end="1:39.813" itunes:key="L25" ttm:agent="v1"><span begin="1:38.565" end="1:39.813">そうだろう</span></p><p begin="1:39.823" end="1:42.545" itunes:key="L26" ttm:agent="v1"><span begin="1:39.823" end="1:40.301">ディス</span><span begin="1:40.301" end="1:40.933">ボード</span> <span begin="1:40.933" end="1:42.545">電源を繋ぐ</span></p><p begin="1:42.555" end="1:46.559" itunes:key="L27" ttm:agent="v1"><span begin="1:42.555" end="1:42.983">星</span><span begin="1:42.983" end="1:43.782">灯りの</span><span begin="1:43.782" end="1:44.625">ように</span><span begin="1:44.625" end="1:45.332">光</span><span begin="1:45.332" end="1:45.858">り</span><span begin="1:45.858" end="1:46.033">出</span><span begin="1:46.033" end="1:46.559">せ</span></p><p begin="1:46.569" end="1:48.678" itunes:key="L28" ttm:agent="v1"><span begin="1:46.569" end="1:46.922">わ</span><span begin="1:46.922" end="1:47.190">た</span><span begin="1:47.190" end="1:47.872">しだけの</span><span begin="1:47.872" end="1:48.678">音</span></p></div><div begin="2:01.545" end="3:15.488"><p begin="2:01.545" end="2:07.055" itunes:key="L29" ttm:agent="v1"><span begin="2:01.545" end="2:02.823">ギター</span><span begin="2:02.823" end="2:03.110">の</span><span begin="2:03.110" end="2:04.164">弦が</span><span begin="2:04.164" end="2:04.433">揺</span><span begin="2:04.433" end="2:05.367">れ</span><span begin="2:05.367" end="2:05.517">る</span><span begin="2:05.517" end="2:05.761">た</span><span begin="2:05.761" end="2:07.055">び</span></p><p begin="2:07.065" end="2:12.609" itunes:key="L30" ttm:agent="v1"><span begin="2:07.065" end="2:08.249">揺るが</span><span begin="2:08.249" end="2:09.858">ないものに</span><span begin="2:09.858" end="2:10.509">変</span><span begin="2:10.509" end="2:11.186">わっ</span><span begin="2:11.186" end="2:11.795">て</span><span begin="2:11.795" end="2:11.895">ゆ</span><span begin="2:11.895" end="2:12.609">く</span></p><p begin="2:12.619" end="2:23.634" itunes:key="L31" ttm:agent="v1"><span begin="2:12.619" end="2:14.269">指先が</span><span begin="2:14.269" end="2:15.323">硬く</span><span begin="2:15.323" end="2:16.190">な</span><span begin="2:16.190" end="2:16.420">る</span><span begin="2:16.420" end="2:16.602">た</span><span begin="2:16.602" end="2:17.209">び</span> <span begin="2:17.328" end="2:18.005">この</span><span begin="2:18.005" end="2:19.010">意</span><span begin="2:19.010" end="2:19.691">志も</span><span begin="2:19.875" end="2:20.834">固</span><span begin="2:20.834" end="2:21.288">く</span><span begin="2:21.322" end="2:21.984">な</span><span begin="2:22.093" end="2:22.863">る</span><span begin="2:22.863" end="2:23.634">の</span></p><p begin="2:24.696" end="2:26.938" itunes:key="L32" ttm:agent="v1"><span begin="2:24.696" end="2:25.273">ディス</span><span begin="2:25.273" end="2:25.932">トーション</span><span begin="2:25.932" end="2:26.302">の</span><span begin="2:26.302" end="2:26.938">音色</span></p><p begin="2:26.953" end="2:30.317" itunes:key="L33" ttm:agent="v1"><span begin="2:26.953" end="2:27.447">これっ</span><span begin="2:27.447" end="2:27.964">ぽっ</span><span begin="2:27.964" end="2:28.453">ちじゃ</span><span begin="2:28.453" end="2:28.876">まだ</span><span begin="2:28.876" end="2:30.024">終わらな</span><span begin="2:30.024" end="2:30.317">い</span></p><p begin="2:30.327" end="2:34.500" itunes:key="L34" ttm:agent="v1"><span begin="2:30.327" end="2:31.370">最前で</span><span begin="2:31.370" end="2:32.444">ハイゲインを</span><span begin="2:32.444" end="2:33.427">受け止めて</span><span begin="2:33.427" end="2:34.500">みてよ</span></p><p begin="2:34.510" end="2:35.756" itunes:key="L35" ttm:agent="v1"><span begin="2:34.510" end="2:35.756">今夜も</span></p><p begin="2:35.771" end="2:37.946" itunes:key="L36" ttm:agent="v1"><span begin="2:35.771" end="2:36.859">Distortion,</span> <span begin="2:36.859" end="2:37.403">it's</span> <span begin="2:37.403" end="2:37.946">Motion</span></p><p begin="2:37.803" end="2:41.164" itunes:key="L37" ttm:agent="v1"><span begin="2:37.803" end="2:38.284">始</span><span begin="2:38.284" end="2:38.884">まっ</span><span begin="2:38.884" end="2:39.366">たら</span><span begin="2:39.366" end="2:39.709">もう</span><span begin="2:39.709" end="2:39.904">止</span><span begin="2:39.904" end="2:40.265">ま</span><span begin="2:40.265" end="2:40.586">ら</span><span begin="2:40.586" end="2:41.164">ない</span></p><p begin="2:41.211" end="2:45.322" itunes:key="L38" ttm:agent="v1"><span begin="2:41.211" end="2:42.284">制限も</span><span begin="2:42.284" end="2:43.305">経験で</span><span begin="2:43.305" end="2:44.028">塗り替え</span><span begin="2:44.028" end="2:44.996">られる</span><span begin="2:44.996" end="2:45.322">さ</span></p><p begin="2:45.332" end="2:46.601" itunes:key="L39" ttm:agent="v1"><span begin="2:45.332" end="2:46.601">そうだろう</span></p><p begin="2:46.611" end="2:48.700" itunes:key="L40" ttm:agent="v1"><span begin="2:46.611" end="2:47.718">ディストーション</span> <span begin="2:47.718" end="2:48.700">いつもそう</span></p><p begin="2:48.710" end="2:53.199" itunes:key="L41" ttm:agent="v1"><span begin="2:48.710" end="2:49.262">左脳</span><span begin="2:49.262" end="2:49.858">追い</span><span begin="2:49.858" end="2:49.978">越</span><span begin="2:49.978" end="2:50.646">して</span><span begin="2:50.646" end="2:51.457">心</span><span begin="2:51.457" end="2:51.758">が</span><span begin="2:51.758" end="2:52.712">走</span><span begin="2:52.712" end="2:52.951">り</span><span begin="2:52.951" end="2:53.099">出</span><span begin="2:53.099" end="2:53.199">す</span></p><p begin="2:53.212" end="2:54.679" itunes:key="L42" ttm:agent="v1"><span begin="2:53.212" end="2:54.267">君</span><span begin="2:54.267" end="2:54.679">の</span></p><p begin="2:54.883" end="3:00.379" itunes:key="L43" ttm:agent="v1"><span begin="2:54.883" end="2:55.473">次の</span><span begin="2:55.473" end="2:55.923">音</span><span begin="2:55.923" end="2:56.324">に</span><span begin="2:56.324" end="2:56.630">エス</span><span begin="2:56.630" end="2:57.482">コート</span> <span begin="2:57.482" end="2:58.639">日々の憂い</span><span begin="2:58.639" end="2:59.012">に</span><span begin="2:59.012" end="2:59.353">ディス</span><span begin="2:59.353" end="2:59.667">トー</span><span begin="2:59.667" end="3:00.379">ション</span></p><p begin="3:00.389" end="3:02.998" itunes:key="L44" ttm:agent="v1"><span begin="3:00.389" end="3:01.042">ひとりの</span><span begin="3:01.042" end="3:01.464">夜</span> <span begin="3:01.464" end="3:01.782">鳴</span><span begin="3:01.782" end="3:02.090">らす</span><span begin="3:02.090" end="3:02.998">コード</span></p><p begin="3:03.008" end="3:04.434" itunes:key="L45" ttm:agent="v1"><span begin="3:03.008" end="3:03.643">君も</span><span begin="3:03.643" end="3:04.166">同じ</span><span begin="3:04.166" end="3:04.434">かい？</span></p><p begin="3:04.444" end="3:07.239" itunes:key="L46" ttm:agent="v1"><span begin="3:04.444" end="3:05.574">理想像</span> <span begin="3:05.775" end="3:06.521">追いかけ</span><span begin="3:06.521" end="3:06.854">た</span><span begin="3:06.854" end="3:07.239">日々</span></p><p begin="3:07.249" end="3:11.121" itunes:key="L47" ttm:agent="v1"><span begin="3:07.249" end="3:07.549">F</span><span begin="3:07.549" end="3:08.225">コード</span> <span begin="3:08.591" end="3:09.507">掻き鳴らすん</span><span begin="3:09.507" end="3:09.923">だ</span><span begin="3:09.923" end="3:10.288">ディス</span><span begin="3:10.288" end="3:11.121">トーション</span></p><p begin="3:11.205" end="3:15.488" itunes:key="L48" ttm:agent="v1"><span begin="3:11.205" end="3:11.996">ボリューム</span><span begin="3:11.996" end="3:12.264">を</span><span begin="3:12.264" end="3:12.987">振り切る</span><span begin="3:12.987" end="3:15.488">よ</span></p></div></body></tt>`,
      'text/xml'
    );
    const result = parser.parse(xml, 'syllable');
    expect(result.resourceID).toBe('syllable');
    expect(result.duration).toBe(202.83);
    expect(result.voids().length).toBe(49);
  });

  it('should parse line TTML document', () => {
    const xml = new DOMParser().parseFromString(
      `<tt xmlns="http://www.w3.org/ns/ttml" xmlns:ttm="http://www.w3.org/ns/ttml#metadata" xml:lang="ja"><head><metadata><ttm:agent type="person" xml:id="v1"/></metadata></head><body dur="3:29.467"><div begin="11.826" end="30.867"><p begin="11.826" end="14.988" ttm:agent="v1">出会って知って 埋まったこの距離は</p><p begin="17.230" end="20.243" ttm:agent="v1">変な感じ 全然慣れないや</p><p begin="21.626" end="25.678" ttm:agent="v1">すべてが逆さまになっちゃったみたい</p><p begin="26.302" end="30.867" ttm:agent="v1">夢みたいなんだ 夢じゃないんだ</p></div><div begin="30.877" end="50.682"><p begin="30.877" end="40.831" ttm:agent="v1">きみがくれるSOSは 僕が全部大丈夫にしたい</p><p begin="41.439" end="50.682" ttm:agent="v1">ふたりぼっちでも大作戦 叶えたいことが曇らないように</p></div><div begin="51.273" end="1:11.576"><p begin="51.273" end="54.885" ttm:agent="v1">もっともっと近付きたいよ</p><p begin="54.888" end="1:01.203" ttm:agent="v1">何度困ってもいいよなんて ひどいかな</p><p begin="1:01.784" end="1:05.448" ttm:agent="v1">ずっとずっとそばにいたいよ</p><p begin="1:05.773" end="1:11.576" ttm:agent="v1">見失っちゃう僕ら 絶対探し合おう</p></div><div begin="1:11.586" end="1:20.300"><p begin="1:11.586" end="1:16.301" ttm:agent="v1">心がふわってしちゃって これっておかしいのかな</p><p begin="1:16.792" end="1:20.300" ttm:agent="v1">この想いの名前を教えて</p></div><div begin="1:25.274" end="1:44.294"><p begin="1:25.274" end="1:28.386" ttm:agent="v1">ひょっとしてきみも同じ気持ち？</p><p begin="1:30.663" end="1:33.707" ttm:agent="v1">勘違いか正解 どっちだろう</p><p begin="1:35.009" end="1:38.987" ttm:agent="v1">確かめたら終わってしまう気がして</p><p begin="1:39.687" end="1:44.294" ttm:agent="v1">ただ笑っていた 嫌われないように</p></div><div begin="1:44.304" end="2:04.194"><p begin="1:44.304" end="1:54.843" ttm:agent="v1">きみがくれるSOSが ずっとずっと止まないでほしいとか</p><p begin="1:54.843" end="2:04.194" ttm:agent="v1">きみと会える理由になるとか 馬鹿みたいだよな…言えやしないのに</p></div><div begin="2:04.761" end="2:25.041"><p begin="2:04.761" end="2:08.318" ttm:agent="v1">もっともっと聴いていたいよ</p><p begin="2:08.318" end="2:14.656" ttm:agent="v1">頬も染まっちゃう距離で きみの願い事</p><p begin="2:15.209" end="2:18.779" ttm:agent="v1">ずっとずっと変わらないよ</p><p begin="2:18.779" end="2:25.041" ttm:agent="v1">退屈なんて言葉は 忘れちゃっていいよね</p></div><div begin="2:25.051" end="2:46.822"><p begin="2:25.051" end="2:26.752" ttm:agent="v1">まだまだ きっと</p><p begin="2:29.661" end="2:31.970" ttm:agent="v1">まだまだまだ もう一歩</p><p begin="2:34.179" end="2:37.290" ttm:agent="v1">まだまだまだまだ ねえ知りたいよ</p><p begin="2:38.843" end="2:42.394" ttm:agent="v1">まだまだまだまだまだ 仲良しの端っこ</p><p begin="2:42.643" end="2:46.822" ttm:agent="v1">まるで足りない</p></div><div begin="2:47.984" end="3:08.296"><p begin="2:47.984" end="2:51.598" ttm:agent="v1">もっともっと近付きたいよ</p><p begin="2:51.608" end="2:58.114" ttm:agent="v1">何度困ってもいいよ 僕が守るから</p><p begin="2:58.555" end="3:02.194" ttm:agent="v1">ずっとずっとそばにいたいよ</p><p begin="3:02.423" end="3:08.296" ttm:agent="v1">見失っちゃう僕ら 絶対探し合おう</p></div><div begin="3:08.306" end="3:17.238"><p begin="3:08.306" end="3:13.139" ttm:agent="v1">心がふわってしちゃって これっておかしいのかな</p><p begin="3:13.525" end="3:17.238" ttm:agent="v1">この想いの名前を教えて</p></div><div begin="3:22.618" end="3:26.416"><p begin="3:22.618" end="3:26.416" ttm:agent="v1">その気持ちの名前を教えて</p></div></body></tt>`,
      'text/xml'
    );
    const result = parser.parse(xml, 'line');
    expect(result.resourceID).toBe('line');
    expect(result.duration).toBe(209.47);
    expect(result.voids().length).toBe(38);
  });
});
